cmake_minimum_required(VERSION 2.8)
project(lizardfs)

if(NOT CMAKE_BUILD_TYPE)
  set(CMAKE_BUILD_TYPE Debug)
endif()
message(STATUS "CMAKE_BUILD_TYPE: ${CMAKE_BUILD_TYPE}")

set(ENABLE_TESTS  NO CACHE STRING "Enable building tests")
set(ENABLE_TRACES NO CACHE STRING "Enable traces")
set(ENABLE_CRC NO CACHE STRING "Enable checksums")
set(THROW_INSTEAD_OF_ABORT NO CACHE STRING "Throw std::exception instead of calling abort")

message(STATUS "ENABLE_TESTS: ${ENABLE_TESTS}")
message(STATUS "ENABLE_TRACES: ${ENABLE_TRACES}")
message(STATUS "ENABLE_CRC: ${ENABLE_CRC}")
message(STATUS "THROW_INSTEAD_OF_ABORT: ${THROW_INSTEAD_OF_ABORT}")

if(ENABLE_TESTS AND NOT THROW_INSTEAD_OF_ABORT)
  message(STATUS "Tests require THROW_INSTEAD_OF_ABORT to be set to YES, changing passed value:")
  set(THROW_INSTEAD_OF_ABORT YES)
  message(STATUS "THROW_INSTEAD_OF_ABORT: ${THROW_INSTEAD_OF_ABORT}")
endif()

set(CMAKE_CXX_FLAGS "-std=c++0x -Wall -Wextra -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -D_GNU_SOURCE -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 -DHAVE_CONFIG_H -pthread")
set(CMAKE_CXX_FLAGS_DEBUG "-O0 -ggdb")
set(CMAKE_CXX_FLAGS_RELEASE "-O3 -DNDEBUG")

function(find_required_library NAME)
  find_library(${NAME}_LIB ${ARGN})
  if(${NAME}_LIB)
    message(STATUS "Library (${ARGV1}) found in ${${NAME}_LIB}")
  else()
    message(FATAL_ERROR "Library (${ARGV1}) not found")
  endif()
endfunction(find_required_library)

find_required_library(M m)
find_required_library(Z z)
find_required_library(FUSE fuse)
find_required_library(DL dl)
find_package(Boost COMPONENTS filesystem system regex thread)

include_directories(${CMAKE_CURRENT_SOURCE_DIR} ${CMAKE_CURRENT_SOURCE_DIR}/cmake_config)
set(MAIN_CC ${CMAKE_SOURCE_DIR}/mfsdaemonmain/main.cc)

if(ENABLE_TRACES)
  if(NOT Boost_FOUND)
    message(FATAL_ERROR "Boost is required if traces are enabled")
  endif()
  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DENABLE_TRACES")
  set(BUILD_DEVTOOLS ON)
  set(MFSCOMMON_ADDITIONAL_LIBS devtools)
endif()

if(THROW_INSTEAD_OF_ABORT)
  add_definitions(-DTHROW_INSTEAD_OF_ABORT)
endif()

if(ENABLE_TESTS)
  if(NOT Boost_FOUND)
    message(FATAL_ERROR "Boost is required by LizardFS tests")
  endif()
  set(BUILD_TESTS ON)
endif()

if(ENABLE_CRC)
    message(STATUS "CRC checksums enabled")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DENABLE_CRC")
else()
    message(STATUS "CRC checksums disabled")
endif()

add_subdirectory(mfscommon)
add_subdirectory(mfsmaster)
add_subdirectory(mfschunkserver)
add_subdirectory(mfsmount)
add_subdirectory(mfstools)
if(BUILD_DEVTOOLS)
  add_subdirectory(devtools)
endif()
if(BUILD_TESTS)
  add_subdirectory(tests)
endif()
